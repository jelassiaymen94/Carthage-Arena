{% extends 'base.html.twig' %}

{% block title %}Carthage Arena - Détails du Tournoi{% endblock %}

{% block body %}
    <div
      id="mainContent"
      class="flex h-screen w-full opacity-0 transition-opacity duration-500"
    >
      <!-- Sidebar -->
      {% embed 'components/_sidebar.html.twig' %}
        {% block sidebar_bottom %}
        <div
          class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-900 to-black p-4 border border-white/10"
        >
          <div
            class="absolute -right-6 -top-6 h-24 w-24 rounded-full bg-primary/20 blur-2xl"
          ></div>
          <div class="relative z-10 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <p
                class="text-[10px] font-bold uppercase tracking-widest text-primary"
              >
                Match en Direct
              </p>
              <span class="relative flex h-2 w-2">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
                ></span>
                <span
                  class="relative inline-flex rounded-full h-2 w-2 bg-red-500"
                ></span>
              </span>
            </div>
            <div
              class="h-24 w-full rounded-lg bg-cover bg-center shadow-inner relative group cursor-pointer"
              style="
                background-image: url(&quot;https://lh3.googleusercontent.com/aida-public/AB6AXuA4obZy358tBVVcFMP79b-z7bAvQYv4HJ0LRm36nfn3_oRAKCUt6GILwJqBao7Y428Xkg5wm6xHfl8LZZMiq3IrRsSiO7cvZpJSAg4zN1ojnhKbRwUaKLdqdKRYLSipLJGrLCTrQ14In62yTLIO31vGkYX3Zg0UK4BRPqb8CVZEW0YvlhfztGhCwlxjW8qmX8SSBSxvbJrA_INMrr32VBp4A1aHfwFpJtbKnC6hJoSos2AZxwARh_jam2q38VDCc3VUUVDJUwGZGBE&quot;);
              "
            >
              <div
                class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-3xl drop-shadow-lg"
                  >play_circle</span
                >
              </div>
            </div>
            <div>
              <h4 class="text-sm font-bold text-white">T1 vs Gen.G</h4>
              <p class="text-xs text-gray-400">Finale &bull; Carte 3</p>
            </div>
            <button
              class="mt-1 w-full rounded-full bg-white/5 py-2 px-4 text-xs font-bold text-white hover:bg-white/10 transition-colors border border-white/5"
            >
              Regarder le Stream
            </button>
          </div>
        </div>
        {% endblock %}
      {% endembed %}
      <main
        class="flex flex-1 flex-col overflow-y-auto bg-background-dark relative"
      >
        <header
          class="sticky top-0 z-50 flex h-20 items-center justify-between border-b border-white/5 bg-background-dark/80 backdrop-blur-md px-8 py-4"
        >
          <div class="flex flex-col">
            <h2 class="text-2xl font-bold text-white">Détails du Tournoi</h2>
            <div class="flex items-center gap-2">
              <p class="text-xs text-gray-400">Saison {{ tournoi.dateDebut|date('Y') }}</p>
              <span class="h-1 w-1 rounded-full bg-gray-600"></span>
              <p class="text-xs text-gray-400">Phase Éliminatoire</p>
            </div>
          </div>
          <div class="flex items-center gap-6">
            {% include 'components/_header_user_info.html.twig' %}
          </div>
        </header>
        <div class="flex flex-col gap-6 p-4 md:p-8 max-w-7xl mx-auto w-full">
          <div
            class="relative w-full h-[320px] rounded-3xl overflow-hidden border border-white/10 shadow-2xl group"
          >
            <div
              class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                style="
                background-image: url('{{ (tournoi.game and tournoi.game.imageUrl) ? tournoi.game.imageUrl : 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=800&h=400&fit=crop' }}');
              "
            ></div>
            <div
              class="absolute inset-0 bg-gradient-to-t from-background-dark via-[#121212]/80 to-transparent"
            ></div>
            <div
              class="absolute inset-0 bg-gradient-to-r from-background-dark/90 via-transparent to-transparent"
            ></div>
            <div
              class="absolute bottom-0 left-0 p-8 w-full md:w-2/3 flex flex-col gap-4"
            >
              <div class="flex items-center gap-3">
                <span
                  class="px-3 py-1 bg-secondary text-black text-[10px] font-black uppercase tracking-wider rounded-md"
                  >{{ tournoi.status.value }}</span
                >
                {% if tournoi.game %}
                <span
                  class="px-3 py-1 bg-white/10 backdrop-blur-md text-white border border-white/10 text-[10px] font-bold uppercase tracking-wider rounded-md"
                  >{{ tournoi.game.name }}</span
                >
                {% endif %}
              </div>
              <h1
                class="text-3xl md:text-5xl font-black text-white italic tracking-tight drop-shadow-xl uppercase"
              >
                {{ tournoi.nom }}
              </h1>
              <p
                class="text-gray-300 text-sm md:text-base max-w-xl line-clamp-2"
              >
                Un tournoi {{ tournoi.type.value }} {% if tournoi.game %}sur {{ tournoi.game.name }}{% endif %}.
              </p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 flex flex-col gap-6">
              <div
                class="bg-surface-dark border border-white/5 rounded-3xl p-6 relative overflow-hidden"
              >
                <div
                  class="absolute top-0 right-0 p-32 bg-primary/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"
                ></div>
                <div class="flex flex-col md:flex-row gap-8 relative z-10">
                  <div
                    class="flex flex-col justify-center items-center md:items-start min-w-[200px] border-b md:border-b-0 md:border-r border-white/10 pb-6 md:pb-0 md:pr-8"
                  >
                    <span
                      class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2"
                      >Cashprize Total</span
                    >
                    <div class="flex items-center gap-2 text-secondary">
                      <span class="material-symbols-outlined text-4xl"
                        >emoji_events</span
                      >
                      <span
                        class="text-4xl md:text-5xl font-black tracking-tighter"
                        >{{ tournoi.prizePool|number_format(0, ',', ' ') }} <span class="text-2xl ml-1">DT</span></span
                      >
                    </div>
                    <span
                      class="text-[10px] text-gray-500 mt-2 bg-white/5 px-2 py-1 rounded"
                      >Réparti sur le top 3</span
                    >
                  </div>
                  <div class="flex-1">
                    <h3
                      class="text-lg font-bold text-white mb-4 flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined text-primary"
                        >gavel</span
                      >
                      Règlement du Tournoi
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="flex items-start gap-3">
                        <div
                          class="mt-1 h-5 w-5 rounded-full bg-white/5 flex items-center justify-center shrink-0"
                        >
                          <span
                            class="material-symbols-outlined text-[14px] text-gray-400"
                            >swords</span
                          >
                        </div>
                        <div>
                          <p class="text-sm font-bold text-gray-200">Format</p>
                          <p class="text-xs text-gray-500">
                            {{ tournoi.type.value }}
                          </p>
                        </div>
                      </div>
                      <div class="flex items-start gap-3">
                        <div
                          class="mt-1 h-5 w-5 rounded-full bg-white/5 flex items-center justify-center shrink-0"
                        >
                          <span
                            class="material-symbols-outlined text-[14px] text-gray-400"
                            >group</span
                          >
                        </div>
                        <div>
                          <p class="text-sm font-bold text-gray-200">Equipes</p>
                          <p class="text-xs text-gray-500">
                            {{ tournoi.nbEquipesMax }} équipes max.
                          </p>
                        </div>
                      </div>
                      <div class="flex items-start gap-3">
                        <div
                          class="mt-1 h-5 w-5 rounded-full bg-white/5 flex items-center justify-center shrink-0"
                        >
                          <span
                            class="material-symbols-outlined text-[14px] text-gray-400"
                            >schedule</span
                          >
                        </div>
                        <div>
                          <p class="text-sm font-bold text-gray-200">Dates</p>
                          <p class="text-xs text-gray-500">
                            Du {{ tournoi.dateDebut|date('d/m') }} au {{ tournoi.dateFin|date('d/m/Y') }}
                          </p>
                        </div>
                      </div>
                      <div class="flex items-start gap-3">
                        <div
                          class="mt-1 h-5 w-5 rounded-full bg-white/5 flex items-center justify-center shrink-0"
                        >
                          <span
                            class="material-symbols-outlined text-[14px] text-gray-400"
                            >computer</span
                          >
                        </div>
                        <div>
                          <p class="text-sm font-bold text-gray-200">
                            Plateforme
                          </p>
                          <p class="text-xs text-gray-500">
                            Tournoi PC uniquement. Discord obligatoire.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
                  <div class="flex-1">
                    <h3
                      class="text-lg font-bold text-white mb-4 flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined text-primary"
                        >sports_esports</span
                      >
                      Matchs du Tournoi
                    </h3>
                    
                    {% if tournoi.getMatches()|length > 0 %}
                        {% set matchesByRound = {} %}
                        {% for match in tournoi.getMatches() %}
                            {% set round = 'round_' ~ match.round %}
                            {% if matchesByRound[round] is not defined %}
                                {% set matchesByRound = matchesByRound|merge({(round): []}) %}
                            {% endif %}
                            {% set matchesByRound = matchesByRound|merge({(round): matchesByRound[round]|merge([match])}) %}
                        {% endfor %}

                        <div class="space-y-4">
                            {% for roundKey, matches in matchesByRound %}
                                {% set roundNumber = roundKey|replace({'round_': ''}) %}
                                <div class="bg-white/5 rounded-2xl p-4 border border-white/10">
                                    <h4 class="text-white font-bold mb-3 flex items-center gap-2">
                                        <span class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center text-primary text-sm font-black">{{ roundNumber }}</span>
                                        Round {{ roundNumber }}
                                        {% if tournoi.type.value == 'elimination' %}
                                            {% if roundNumber == (matchesByRound|length) %}
                                                <span class="text-xs text-yellow-400 bg-yellow-400/10 px-2 py-1 rounded-full font-bold">FINALE</span>
                                            {% elseif roundNumber == (matchesByRound|length - 1) %}
                                                <span class="text-xs text-orange-400 bg-orange-400/10 px-2 py-1 rounded-full font-bold">DEMI-FINALES</span>
                                            {% endif %}
                                        {% endif %}
                                    </h4>
                                    <div class="space-y-2">
                                        {% for match in matches %}
                                            <div class="bg-surface-dark/80 rounded-xl p-4 border border-white/5 hover:border-primary/30 transition-all group">
                                                <div class="flex items-center justify-between gap-4">
                                                    <div class="flex-1 flex items-center justify-between">
                                                        {% if match.team1 %}
                                                            <div class="flex items-center gap-2 flex-1">
                                                                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-black text-xs">
                                                                    {{ match.team1.name|slice(0, 2)|upper }}
                                                                </div>
                                                                <span class="text-white font-bold group-hover:text-primary transition-colors">{{ match.team1.name }}</span>
                                                            </div>
                                                        {% else %}
                                                            <div class="flex items-center gap-2 flex-1">
                                                                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center">
                                                                    <span class="material-symbols-outlined text-gray-600 text-sm">help</span>
                                                                </div>
                                                                <span class="text-gray-500 italic text-sm">À déterminer</span>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="px-4">
                                                            <span class="text-white/40 font-black text-sm">VS</span>
                                                        </div>
                                                        
                                                        {% if match.team2 %}
                                                            <div class="flex items-center gap-2 flex-1 justify-end">
                                                                <span class="text-white font-bold group-hover:text-primary transition-colors">{{ match.team2.name }}</span>
                                                                <div class="w-8 h-8 rounded-lg bg-red-600 flex items-center justify-center text-white font-black text-xs">
                                                                    {{ match.team2.name|slice(0, 2)|upper }}
                                                                </div>
                                                            </div>
                                                        {% else %}
                                                            <div class="flex items-center gap-2 flex-1 justify-end">
                                                                <span class="text-gray-500 italic text-sm">À déterminer</span>
                                                                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center">
                                                                    <span class="material-symbols-outlined text-gray-600 text-sm">help</span>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="ml-4">
                                                        <span class="px-3 py-1 rounded-lg text-xs font-bold
                                                            {% if match.status.value == 'scheduled' %}bg-blue-500/20 text-blue-400 border border-blue-500/30
                                                            {% elseif match.status.value == 'in_progress' %}bg-yellow-500/20 text-yellow-400 border border-yellow-500/30
                                                            {% elseif match.status.value == 'completed' %}bg-green-500/20 text-green-400 border border-green-500/30
                                                            {% else %}bg-gray-500/20 text-gray-400 border border-gray-500/30{% endif %}">
                                                            {% if match.status.value == 'scheduled' %}PROGRAMMÉ
                                                            {% elseif match.status.value == 'in_progress' %}EN COURS
                                                            {% elseif match.status.value == 'completed' %}TERMINÉ
                                                            {% else %}{{ match.status.value|upper }}{% endif %}
                                                        </span>
                                                    </div>
                                                </div>
                                                {% if match.scheduledAt %}
                                                    <div class="mt-2 pt-2 border-t border-white/5 flex items-center gap-2 text-xs text-gray-400">
                                                        <span class="material-symbols-outlined text-sm">schedule</span>
                                                        <span>{{ match.scheduledAt|date('d M Y') }}</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex flex-col items-center justify-center h-64 bg-white/5 rounded-xl border border-white/10 p-8 text-center">
                            <span class="material-symbols-outlined text-4xl text-gray-500 mb-3">sports_esports</span>
                            <h4 class="text-lg font-bold text-white">Aucun match généré</h4>
                            <p class="text-sm text-gray-400 mt-2 max-w-xs">Les matchs seront disponibles une fois que l'administrateur aura généré le bracket du tournoi.</p>
                        </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            <div class="lg:col-span-1 flex flex-col gap-6">
              <div
                class="bg-surface-dark border border-white/5 rounded-3xl p-6 flex flex-col gap-4 shadow-xl relative overflow-hidden"
              >
                <div
                  class="absolute inset-0 bg-gradient-to-b from-primary/5 to-transparent pointer-events-none"
                ></div>
                <div class="flex justify-between items-end">
                  <div>
                    <p class="text-sm text-gray-400">Inscriptions</p>
                    <p class="text-2xl font-black text-white">
                      {{ tournoi.teams|length }} <span class="text-gray-600 text-lg">/ {{ tournoi.nbEquipesMax }}</span>
                    </p>
                  </div>
                  <div class="text-right">
                    <p
                      class="text-[10px] text-gray-400 uppercase tracking-wider font-bold"
                    >
                      Clôture le
                    </p>
                    <p class="text-sm font-bold text-white">{{ tournoi.dateFin|date('d M Y') }}</p>
                  </div>
                </div>
                <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden">
                  <div
                    class="bg-primary h-full rounded-full shadow-[0_0_10px_rgba(230,0,19,0.5)]"
                    style="width: {{ (tournoi.teams|length / tournoi.nbEquipesMax) * 100 }}%"
                  ></div>
                </div>
                <div class="space-y-3 pt-2">
                  <div class="flex items-center gap-2 text-sm text-gray-300">
                    <span
                      class="material-symbols-outlined text-green-500 text-lg"
                      >check_circle</span
                    >
                    <span>Equipe complète requise</span>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-gray-300">
                    <span
                      class="material-symbols-outlined text-green-500 text-lg"
                      >check_circle</span
                    >
                    <span>Frais: Gratuit</span>
                  </div>
                </div>
                <button
                  class="w-full py-3 px-6 mt-2 rounded-xl bg-primary text-white font-bold text-lg shadow-lg shadow-red-900/30 hover:bg-red-600 hover:shadow-red-600/40 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  aria-label="Rejoindre le tournoi avec mon équipe"
                  {% if tournoi.teams|length >= tournoi.nbEquipesMax %}disabled{% endif %}
                >
                  {% if tournoi.teams|length >= tournoi.nbEquipesMax %}
                    Complet
                  {% else %}
                    Rejoindre avec mon équipe
                    <span class="material-symbols-outlined">arrow_forward</span>
                  {% endif %}
                </button>
              </div>
              <div
                class="bg-surface-dark border border-white/5 rounded-3xl p-6 flex-1"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-sm font-bold text-white uppercase tracking-wider"
                  >
                    Équipes Inscrites
                  </h3>
                  <button
                    class="text-xs text-primary hover:text-white transition-colors"
                    aria-label="Voir toutes les équipes inscrites"
                  >
                    Voir tout
                  </button>
                </div>
                <div
                  class="flex flex-col gap-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar"
                >
                  {% set teamColors = ['bg-blue-600', 'bg-yellow-500', 'bg-purple-600', 'bg-red-600', 'bg-orange-600'] %}
                  {% set teamTextColors = ['text-white', 'text-black', 'text-white', 'text-white', 'text-white'] %}
                  
                  {% if tournoi.teams is empty %}
                    <p class="text-sm text-gray-500 text-center py-4">Aucune équipe inscrite pour le moment.</p>
                  {% else %}
                      {% for team in tournoi.teams %}
                      <div
                        class="flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors cursor-pointer group"
                      >
                        <div class="flex items-center gap-3">
                          <div
                            class="h-10 w-10 rounded-lg {{ teamColors[loop.index0 % 5] }} flex items-center justify-center {{ teamTextColors[loop.index0 % 5] }} font-black shadow-lg"
                          >
                            {{ team.name|slice(0, 2)|upper }}
                          </div>
                          <div>
                            <p
                              class="text-sm font-bold text-white group-hover:text-primary transition-colors"
                            >
                              {{ team.name }}
                            </p>
                            <p class="text-[10px] text-gray-400">
                              {{ team.members|length }} membres &bull; <span class="text-green-400">Inscrit</span>
                            </p>
                          </div>
                        </div>
                        <span
                          class="material-symbols-outlined text-gray-600 group-hover:text-white text-lg"
                          >chevron_right</span
                        >
                      </div>
                      {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% include 'components/_mobile_nav.html.twig' %}
      </main>
    </div>
{% endblock %}
